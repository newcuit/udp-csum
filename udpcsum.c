#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdint.h>

uint8_t udp_pseudo[] = {0x0a, 0x7b, 0x77,0x62,0x09,0x86,0xf5,0x64,0x00,0x11,0x00, 0x00};
uint8_t udp_playload[] = {0x00,0x35,0xc3,0x3a,0x00,0xc0,0x00,0x00,0x5b,0x91,0x81,0x00,0x00,0x01,
			  0x00,0x04,0x00,0x00,0x00,0x00,0x02,0x71,0x71,0x03,0x63,0x6f,0x6d,0x00,0x00,0x01,
			  0x00,0x01,0xc0,0x0c,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x73,0x00,0x04,0x7b,0x97,
			  0x89,0x12,0xc0,0x0c,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x73,0x00,0x04,0xb7,0x03,
			  0xe2,0x23,0xc0,0x0c,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x73,0x00,0x04,0x3d,0x81,
			  0x07,0x2f,0xc0,0x0c,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x73,0x00,0x04,0xcb,0xcd,
			  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			  0x00,0x00};

/*
 struct udp_pseudo_header {
 	uint32_t saddr;
 	uint32_t daddr;
 	uint8_t  zero;
	uint8_t  proto;
	uint16_t udp_len;
 };

 struct udp_header {
     uint16_t sport;
     uint16_t dport;
     uint16_t udp_len;
     uint16_t csum;
 };
 */

static uint16_t udp_csum(uint16_t *data, int size)
{
	uint16_t i;
	uint32_t csum = 0;

	for (i = 0; i < size / sizeof(uint16_t); i++) {
		csum += data[i];
	} 

	if (size % 2)
		csum += *((uint8_t *)data + size - 1); 

	csum = (csum >> 16) + (csum & 0xffff);
	return ~csum;
}

int main(void)
{
	uint16_t csum;
	uint8_t data[300];
	int j = 0, i = 0;

	/* udp pseudo header */
	udp_pseudo[sizeof(udp_pseudo) - 1] = sizeof(udp_playload);
	for (i = 0; i < sizeof(udp_pseudo); i++) {
		if (i %10 == 0) printf("\n");
		printf("0x%02X ", udp_pseudo[i]);

		data[j++] = udp_pseudo[i];
	}
	printf("\n");

	/* udp header + udp data */
	printf("data len = %d\n", sizeof(udp_playload));
	printf ("data:\n");
	for (i = 0; i < sizeof(udp_playload); i++) {
		if (i %10 == 0) printf("\n");
		printf("0x%02X ", udp_playload[i]);
		data[j++] = udp_playload[i];
	}
	printf("\n");

	/* calc udp pseudo header + udp header + udp data */
	csum = udp_csum((uint16_t *)data, j);
	printf ("csum = 0x%x, should be 0x52e9\n", csum);

	return 0;
}
